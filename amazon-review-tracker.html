<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazonæ›¸ç±ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ãƒˆãƒ©ãƒƒã‚«ãƒ¼ - è¨­å®š</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style-settings.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“š Amazonæ›¸ç±ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
        
        <form id="settingsForm">
            <!-- æ›¸ç±URLã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="form-group">
                <div class="section-title">ğŸ“š æ›¸ç±æƒ…å ±</div>
                <label for="bookUrl">Amazonæ›¸ç±URL <span class="required">*</span></label>
                <div class="input-with-button">
                    <input type="url" id="bookUrl" name="bookUrl" placeholder="https://www.amazon.co.jp/dp/..." required>
                    <button type="button" id="fetchAllBtn" class="btn-fetch" style="background: linear-gradient(45deg, #e67e22, #f39c12);">ğŸš€ è‡ªå‹•å–å¾—</button>
                </div>
                <div class="fetch-status" id="fetchAllStatus"></div>
                <div class="error" id="bookUrlError">æœ‰åŠ¹ãªAmazonã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                <div class="auto-fetch-info">
                    ğŸ† URLã‚’å…¥åŠ›ã—ã¦è‡ªå‹•å–å¾—ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ãƒ»æ›¸å½±ãŒè‡ªå‹•ã§å–å¾—ã•ã‚Œã¾ã™ï¼
                </div>
            </div>

            <!-- ç›®æ¨™è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="form-group">
                <div class="section-title">ğŸ¯ ç›®æ¨™è¨­å®š</div>
                
                <label for="targetReviews">ç›®æ¨™ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•° <span class="required">*</span></label>
                <input type="number" id="targetReviews" name="targetReviews" required min="1" placeholder="100">
                <div class="error" id="targetReviewsError">1ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>

                <label for="stretchReviews" style="margin-top: 15px;">ã‚¹ãƒˆãƒ¬ãƒƒãƒç›®æ¨™ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•° <span class="required">*</span></label>
                <input type="number" id="stretchReviews" name="stretchReviews" required min="1" placeholder="200">
                <div class="error" id="stretchReviewsError">ç›®æ¨™ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã‚ˆã‚Šå¤§ãã„æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            </div>

            <div class="preview-section">
                <div class="preview-title">ğŸ“Š è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div class="preview-item">
                    <span class="preview-label">æ›¸ç±ã‚¿ã‚¤ãƒˆãƒ«:</span>
                    <span class="preview-value" id="previewTitle">æœªè¨­å®š</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">è‘—è€…å:</span>
                    <span class="preview-value" id="previewAuthor">æœªè¨­å®š</span>
                    <button type="button" id="editAuthorBtn" class="btn-edit" style="display: none; margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #4ecdc4; color: white; border: none; border-radius: 4px; cursor: pointer;">âœï¸ ä¿®æ­£</button>
                </div>
                <div class="preview-item">
                    <span class="preview-label">ç¾åœ¨ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°:</span>
                    <span class="preview-value" id="previewCurrent">0</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">ç›®æ¨™ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°:</span>
                    <span class="preview-value" id="previewTarget">æœªè¨­å®š</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">ã‚¹ãƒˆãƒ¬ãƒƒãƒç›®æ¨™:</span>
                    <span class="preview-value" id="previewStretch">æœªè¨­å®š</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">é”æˆç‡:</span>
                    <span class="preview-value" id="previewProgress">0%</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">è‡ªå‹•å–å¾—çŠ¶æ…‹:</span>
                    <span class="preview-value" id="previewAutoFetch">æœªå–å¾—</span>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-primary">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                <a href="amazon-review-visual.html" class="btn btn-secondary">ğŸ“Š ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤º</a>
            </div>
        </form>
    </div>

    <script>
        const STORAGE_KEY = 'amazonReviewTracker';

        // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®å–å¾—
        const form = document.getElementById('settingsForm');
        const inputs = {
            bookUrl: document.getElementById('bookUrl'),
            targetReviews: document.getElementById('targetReviews'),
            stretchReviews: document.getElementById('stretchReviews')
        };

        // è‡ªå‹•å–å¾—ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let fetchedData = {
            bookTitle: '',
            bookAuthor: '',
            currentReviews: 0,
            bookCoverUrl: ''
        };

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ã®å–å¾—
        const preview = {
            title: document.getElementById('previewTitle'),
            author: document.getElementById('previewAuthor'),
            current: document.getElementById('previewCurrent'),
            target: document.getElementById('previewTarget'),
            stretch: document.getElementById('previewStretch'),
            progress: document.getElementById('previewProgress'),
            autoFetch: document.getElementById('previewAutoFetch')
        };

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    inputs.bookUrl.value = data.bookUrl || '';
                    inputs.targetReviews.value = data.targetReviews || '';
                    inputs.stretchReviews.value = data.stretchReviews || '';
                    
                    // è‡ªå‹•å–å¾—ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
                    fetchedData.bookTitle = data.bookTitle || '';
                    fetchedData.bookAuthor = data.bookAuthor || '';
                    fetchedData.currentReviews = data.currentReviews || 0;
                    fetchedData.bookCoverUrl = data.bookCoverUrl || '';
                    
                    updatePreview();
                } catch (e) {
                    console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                }
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveData() {
            const data = {
                bookUrl: inputs.bookUrl.value,
                bookTitle: fetchedData.bookTitle,
                bookAuthor: fetchedData.bookAuthor,
                currentReviews: fetchedData.currentReviews,
                targetReviews: parseInt(inputs.targetReviews.value) || 0,
                stretchReviews: parseInt(inputs.stretchReviews.value) || 0,
                bookCoverUrl: fetchedData.bookCoverUrl,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
        function updatePreview() {
            const target = parseInt(inputs.targetReviews.value) || 0;
            const stretch = parseInt(inputs.stretchReviews.value) || 0;

            // è‡ªå‹•å–å¾—çŠ¶æ…‹ã®æ›´æ–°
            if (fetchedData.bookTitle) {
                preview.autoFetch.textContent = 'å–å¾—æ¸ˆã¿';
                preview.title.textContent = fetchedData.bookTitle;
                preview.author.textContent = fetchedData.bookAuthor || 'æœªè¨­å®š';
                preview.current.textContent = fetchedData.currentReviews;
                
                // è‘—è€…åä¿®æ­£ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡ - ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã•ã‚Œã¦ã„ã‚Œã°å¸¸ã«è¡¨ç¤º
                const editBtn = document.getElementById('editAuthorBtn');
                editBtn.style.display = 'inline-block';
            } else {
                preview.autoFetch.textContent = 'æœªå–å¾—';
                preview.title.textContent = 'æœªè¨­å®š';
                preview.author.textContent = 'æœªè¨­å®š';
                preview.current.textContent = '0';
                document.getElementById('editAuthorBtn').style.display = 'none';
            }

            preview.target.textContent = target > 0 ? target : 'æœªè¨­å®š';
            preview.stretch.textContent = stretch > 0 ? stretch : 'æœªè¨­å®š';

            // é”æˆç‡ã®è¨ˆç®—
            if (target > 0 && fetchedData.currentReviews > 0) {
                const progress = Math.min(Math.round((fetchedData.currentReviews / target) * 100), 100);
                preview.progress.textContent = `${progress}%`;
            } else {
                preview.progress.textContent = '0%';
            }
        }

        // è‘—è€…åæ‰‹å‹•ä¿®æ­£æ©Ÿèƒ½
        function editAuthorName() {
            const currentAuthor = fetchedData.bookAuthor || '';
            const displayAuthor = currentAuthor === '' ? '' : currentAuthor;
            const newAuthor = prompt('è‘—è€…åã‚’å…¥åŠ›ãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„:\nï¼ˆç©ºç™½ã«ã™ã‚‹ã¨ã€Œæœªè¨­å®šã€ã«ãªã‚Šã¾ã™ï¼‰', displayAuthor);
            
            if (newAuthor !== null) {
                if (newAuthor.trim() !== '') {
                    const cleanedAuthor = cleanAuthorName(newAuthor);
                    if (validateAuthorName(cleanedAuthor)) {
                        fetchedData.bookAuthor = cleanedAuthor;
                        updatePreview();
                        console.log('æ‰‹å‹•ä¿®æ­£ã§è‘—è€…åã‚’æ›´æ–°:', cleanedAuthor);
                        showFetchStatus('success', `è‘—è€…åã‚’ã€Œ${cleanedAuthor}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`, 'fetchAllStatus');
                    } else {
                        alert('ç„¡åŠ¹ãªè‘—è€…åã§ã™ã€‚2-50æ–‡å­—ã§ã€é©åˆ‡ãªæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
                    }
                } else {
                    // ç©ºæ–‡å­—ã§è‘—è€…åã‚’ã‚¯ãƒªã‚¢
                    fetchedData.bookAuthor = '';
                    updatePreview();
                    console.log('è‘—è€…åã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                    showFetchStatus('success', 'è‘—è€…åã‚’ã€Œæœªè¨­å®šã€ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'fetchAllStatus');
                }
            }
        }

        // Amazon URLã®æ¤œè¨¼
        function isValidAmazonUrl(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname.includes('amazon.co.jp') || urlObj.hostname.includes('amazon.com');
            } catch {
                return false;
            }
        }

        // å¼·åŒ–ã•ã‚ŒãŸè‘—è€…åæŠ½å‡ºã‚¨ãƒ³ã‚¸ãƒ³
        async function extractAuthorName(html, url) {
            console.log('ğŸ” æ”¹è‰¯ç‰ˆè‘—è€…åæŠ½å‡ºã‚¨ãƒ³ã‚¸ãƒ³é–‹å§‹');
            
            // Tier 1: æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º
            let author = await extractFromStructuredData(html);
            if (author) {
                console.log('âœ… Tier 1 (æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿) ã§è‘—è€…åå–å¾—:', author);
                return author;
            }
            
            // Tier 2: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTMLã®æŠ½å‡º
            author = await extractFromSemanticHTML(html);
            if (author) {
                console.log('âœ… Tier 2 (ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTML) ã§è‘—è€…åå–å¾—:', author);
                return author;
            }
            
            // Tier 3: ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
            author = await extractFromTextPatterns(html);
            if (author) {
                console.log('âœ… Tier 3 (ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³) ã§è‘—è€…åå–å¾—:', author);
                return author;
            }
            
            // Tier 4: DOMæ§‹é€ è§£æ
            author = await extractFromDOMAnalysis(html);
            if (author) {
                console.log('âœ… Tier 4 (DOMè§£æ) ã§è‘—è€…åå–å¾—:', author);
                return author;
            }
            
            console.log('âŒ å…¨ã¦ã®æ‰‹æ³•ã§è‘—è€…åå–å¾—ã«å¤±æ•—');
            await logExtractionFailure(html, url);
            return null;
        }

        // Tier 1: æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®æŠ½å‡º
        async function extractFromStructuredData(html) {
            console.log('ğŸ” Tier 1: æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿è§£æ');
            
            // JSON-LDæŠ½å‡º
            const jsonLdPatterns = [
                // åŸºæœ¬çš„ãªJSON-LDæ§‹é€ 
                /"@type"\s*:\s*"Person"[^}]*?"name"\s*:\s*"([^"]+?)"/gi,
                /"author"[^}]*?"name"\s*:\s*"([^"]+?)"/gi,
                /"author"\s*:\s*{\s*"@type"\s*:\s*"Person"[^}]*?"name"\s*:\s*"([^"]+?)"/gi,
                
                // é…åˆ—å½¢å¼ã®authors
                /"authors?"[^[]*?\[\s*{\s*"@type"\s*:\s*"Person"[^}]*?"name"\s*:\s*"([^"]+?)"/gi,
                
                // Bookã®authorãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
                /"@type"\s*:\s*"Book"[^}]*?"author"[^}]*?"name"\s*:\s*"([^"]+?)"/gi,
            ];
            
            for (const pattern of jsonLdPatterns) {
                const matches = [...html.matchAll(pattern)];
                for (const match of matches) {
                    const candidate = cleanAuthorName(match[1]);
                    if (validateAuthorName(candidate)) {
                        console.log('JSON-LD ã‹ã‚‰è‘—è€…åæŠ½å‡º:', candidate);
                        return candidate;
                    }
                }
            }
            
            // MicrodataæŠ½å‡º
            const microdataPatterns = [
                /itemprop="author"[^>]*>([^<]+)/gi,
                /itemprop="name"[^>]*>([^<]+)/gi,
                /itemtype="[^"]*Person"[^>]*>[^<]*<[^>]*itemprop="name"[^>]*>([^<]+)/gi,
            ];
            
            for (const pattern of microdataPatterns) {
                const matches = [...html.matchAll(pattern)];
                for (const match of matches) {
                    const candidate = cleanAuthorName(match[1]);
                    if (validateAuthorName(candidate)) {
                        console.log('Microdata ã‹ã‚‰è‘—è€…åæŠ½å‡º:', candidate);
                        return candidate;
                    }
                }
            }
            
            return null;
        }

        // Tier 2: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTMLã‹ã‚‰ã®æŠ½å‡º
        async function extractFromSemanticHTML(html) {
            console.log('ğŸ” Tier 2: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTMLè§£æ');
            
            const semanticPatterns = [
                // author/bylineç³»ã®ã‚¯ãƒ©ã‚¹ãƒ»ID
                /<[^>]*(?:class|id)="[^"]*author[^"]*"[^>]*>(?:<[^>]*>)*([^<]+?)(?:<\/[^>]*>)*<\/[^>]+>/gi,
                /<[^>]*(?:class|id)="[^"]*byline[^"]*"[^>]*>(?:<[^>]*>)*([^<]+?)(?:<\/[^>]*>)*<\/[^>]+>/gi,
                /<[^>]*(?:class|id)="[^"]*contributor[^"]*"[^>]*>(?:<[^>]*>)*([^<]+?)(?:<\/[^>]*>)*<\/[^>]+>/gi,
                
                // dataå±æ€§ãƒ™ãƒ¼ã‚¹
                /<[^>]*data-[^=]*author[^=]*="[^"]*"[^>]*>([^<]+?)<\/[^>]+>/gi,
                /<[^>]*data-testid="[^"]*author[^"]*"[^>]*>([^<]+?)<\/[^>]+>/gi,
                
                // ariaå±æ€§ãƒ™ãƒ¼ã‚¹
                /<[^>]*aria-label="[^"]*author[^"]*"[^>]*>([^<]+?)<\/[^>]+>/gi,
                /<[^>]*role="[^"]*author[^"]*"[^>]*>([^<]+?)<\/[^>]+>/gi,
                
                // è‘—è€…å°‚ç”¨ã‚¿ã‚°ï¼ˆHTML5ï¼‰
                /<address[^>]*>([^<]+?)<\/address>/gi,
                
                // linkè¦ç´ ã®author
                /<link[^>]*rel="author"[^>]*title="([^"]+?)"/gi,
            ];
            
            for (const pattern of semanticPatterns) {
                const matches = [...html.matchAll(pattern)];
                for (const match of matches) {
                    const candidate = cleanAuthorName(match[1]);
                    if (validateAuthorName(candidate)) {
                        console.log('ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTML ã‹ã‚‰è‘—è€…åæŠ½å‡º:', candidate);
                        return candidate;
                    }
                }
            }
            
            return null;
        }

        // Tier 3: ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
        async function extractFromTextPatterns(html) {
            console.log('ğŸ” Tier 3: ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³è§£æ');
            
            const textPatterns = [
                // æ—¥æœ¬èªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå„ªå…ˆåº¦é«˜ï¼‰
                /è‘—è€…[ï¼š:\s]*([ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf\s]{2,30}?)(?:\s*[ï¼ˆ(]|<|$)/gi,
                /ä½œè€…[ï¼š:\s]*([ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf\s]{2,30}?)(?:\s*[ï¼ˆ(]|<|$)/gi,
                /([ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf]{2,}[ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf\s]*?)\s*(?:è‘—|\\(è‘—\\)|Author)/gi,
                
                // è‹±èªãƒ‘ã‚¿ãƒ¼ãƒ³
                /By:?\s+([A-Z][a-zA-Z\s.'-]{1,40}?)(?:\s*[,(]|<|$)/gi,
                /Author:?\s+([A-Z][a-zA-Z\s.'-]{1,40}?)(?:\s*[,(]|<|$)/gi,
                /Written by\s+([A-Z][a-zA-Z\s.'-]{1,40}?)(?:\s*[,(]|<|$)/gi,
                
                // bylineå†…ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
                /<[^>]*(?:byline|author)[^>]*>.*?([A-Z][a-zA-Z\s.'-]{1,40}?)(?:\s*Follow|\s*ãƒ•ã‚©ãƒ­ãƒ¼|<\/|$)/gi,
                /<[^>]*(?:byline|author)[^>]*>.*?([ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf]{2,}[ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf\s]*?)(?:\s*Follow|\s*ãƒ•ã‚©ãƒ­ãƒ¼|<\/|$)/gi,
                
                // aã‚¿ã‚°å†…ï¼ˆFollowé™¤å¤–ï¼‰
                /<a[^>]*>\s*([A-Z][a-zA-Z\s.'-]{1,40}?)\s*<\/a>(?!\s*Follow)/gi,
                /<a[^>]*>\s*([ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf]{2,}[ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf\s]*?)\s*<\/a>(?!\s*Follow)/gi,
                
                // è¤‡æ•°è‘—è€…å¯¾å¿œ
                /Authors?[ï¼š:\s]*([A-Z][a-zA-Z\s.'-]+(?:,\s*[A-Z][a-zA-Z\s.'-]+)*?)(?:\s*[,(]|<|$)/gi,
                /è‘—è€…[ï¼š:\s]*([ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf\s]+(?:ã€\s*[ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf\s]+)*?)(?:\s*[ï¼ˆ(]|<|$)/gi,
            ];
            
            let bestCandidate = null;
            let bestScore = 0;
            
            for (const pattern of textPatterns) {
                const matches = [...html.matchAll(pattern)];
                for (const match of matches) {
                    const candidate = cleanAuthorName(match[1]);
                    if (validateAuthorName(candidate)) {
                        const score = scoreAuthorName(candidate);
                        if (score > bestScore) {
                            bestScore = score;
                            bestCandidate = candidate;
                        }
                    }
                }
            }
            
            if (bestCandidate) {
                console.log('ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ ã‹ã‚‰è‘—è€…åæŠ½å‡º:', bestCandidate, 'ã‚¹ã‚³ã‚¢:', bestScore);
                return bestCandidate;
            }
            
            return null;
        }

        // Tier 4: DOMæ§‹é€ è§£æ
        async function extractFromDOMAnalysis(html) {
            console.log('ğŸ” Tier 4: DOMæ§‹é€ è§£æ');
            
            // ç‰¹å®šã®æ§‹é€ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è§£æ
            const structuralPatterns = [
                // ã‚¿ã‚¤ãƒˆãƒ«è¿‘è¾ºã®æ§‹é€ è§£æ
                /<h1[^>]*>.*?<\/h1>[\s\S]{0,500}?([A-Z][a-zA-Z\s.'-]{2,40}?)(?:<|\(|$)/gi,
                /<h1[^>]*>.*?<\/h1>[\s\S]{0,500}?([ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf]{2,}[ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf\s]*?)(?:<|\(|$)/gi,
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã§ã®è‘—è€…æƒ…å ±
                /<t[rd][^>]*>.*?(?:è‘—è€…|Author|By)[^<]*<\/t[rd]>[\s]*<t[rd][^>]*>([^<]+?)<\/t[rd]>/gi,
                
                // ãƒªã‚¹ãƒˆå†…ã®è‘—è€…æƒ…å ±
                /<li[^>]*>.*?(?:è‘—è€…|Author|By)[^<]*([A-Z][a-zA-Z\s.'-]{2,40}?)<\/li>/gi,
                /<li[^>]*>.*?(?:è‘—è€…|Author|By)[^<]*([ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf]{2,}[ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf\s]*?)<\/li>/gi,
            ];
            
            for (const pattern of structuralPatterns) {
                const matches = [...html.matchAll(pattern)];
                for (const match of matches) {
                    const candidate = cleanAuthorName(match[1]);
                    if (validateAuthorName(candidate)) {
                        console.log('DOMæ§‹é€ è§£æ ã‹ã‚‰è‘—è€…åæŠ½å‡º:', candidate);
                        return candidate;
                    }
                }
            }
            
            return null;
        }

        // è‘—è€…åã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
        function cleanAuthorName(rawName) {
            if (!rawName) return '';
            
            return rawName
                .replace(/\s*\(è‘—\)/g, '')
                .replace(/\s*\(Author\)/g, '')
                .replace(/\s*è‘—$/g, '')
                .replace(/\s*Author$/g, '')
                .replace(/Follow/gi, '')
                .replace(/ãƒ•ã‚©ãƒ­ãƒ¼/g, '')
                .replace(/\s*\([^)]*\)\s*/g, ' ') // æ‹¬å¼§å†…ã‚’å‰Šé™¤
                .replace(/[""''""]/g, '') // å¼•ç”¨ç¬¦ã‚’å‰Šé™¤
                .replace(/\s+/g, ' ')
                .trim();
        }

        // è‘—è€…åã®æ¤œè¨¼
        function validateAuthorName(name) {
            if (!name || name.length < 2 || name.length > 50) return false;
            
            // ç„¡åŠ¹ãªç”¨èªã‚’ãƒã‚§ãƒƒã‚¯
            const invalidTerms = [
                'follow', 'more', 'see', 'clothing', 'store', 'shop', 'brand',
                'kindle', 'amazon', 'paperback', 'hardcover', 'format',
                'page', 'pages', 'price', 'buy', 'purchase', 'cart', 'wishlist',
                'review', 'reviews', 'customer', 'rating', 'star', 'stars',
                'visit', 'website', 'profile', 'biography', 'bio', 'more info'
            ];
            
            const lowerName = name.toLowerCase();
            if (invalidTerms.some(term => lowerName.includes(term))) return false;
            
            // æ•°å­—ã®ã¿ã‚„è¨˜å·ã®ã¿ã‚’é™¤å¤–
            if (/^\d+$/.test(name) || /^[^\w\s]*$/.test(name)) return false;
            
            // ç©ºç™½ã®ã¿ã‚’é™¤å¤–
            if (name.trim() === '') return false;
            
            return true;
        }

        // è‘—è€…åã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆå„ªå…ˆåº¦ä»˜ã‘ï¼‰
        function scoreAuthorName(name) {
            let score = 0;
            
            // æ—¥æœ¬èªåã‚’å„ªå…ˆ
            if (/[ã‚-ã‚“ã‚¢-ãƒ³ãƒ¼\u4e00-\u9faf]/.test(name)) score += 10;
            
            // é©åˆ‡ãªé•·ã•
            if (name.length >= 3 && name.length <= 20) score += 5;
            
            // å¤§æ–‡å­—ã§å§‹ã¾ã‚‹è‹±èªå
            if (/^[A-Z][a-z]/.test(name)) score += 3;
            
            // ã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€ï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰
            if (/\s/.test(name) && name.split(' ').length <= 4) score += 2;
            
            return score;
        }

        // æŠ½å‡ºå¤±æ•—æ™‚ã®ãƒ­ã‚°å‡ºåŠ›
        async function logExtractionFailure(html, url) {
            console.log('=== è‘—è€…åæŠ½å‡ºå¤±æ•—ã®è©³ç´°åˆ†æ ===');
            
            // é–¢é€£ã™ã‚‹HTMLæ§‹é€ ã‚’è©³ç´°è¡¨ç¤º
            const relevantSections = [
                html.match(/<[^>]*(?:byline|author|contributor)[^>]*>[\s\S]{0,300}/gi),
                html.match(/<script[^>]*type="application\/ld\+json"[^>]*>[\s\S]*?<\/script>/gi),
                html.match(/<[^>]*(?:class|id)="[^"]*author[^"]*"[^>]*>[\s\S]{0,200}/gi),
            ].filter(Boolean).flat();
            
            console.log('é–¢é€£HTMLæ§‹é€ :');
            relevantSections.forEach((section, index) => {
                console.log(`æ§‹é€  ${index + 1}:`, section.substring(0, 200) + '...');
            });
            
            // URLæƒ…å ±
            console.log('å¯¾è±¡URL:', url);
            console.log('HTMLã‚µã‚¤ã‚º:', html.length, 'æ–‡å­—');
        }

        // ä¸€æ‹¬å–å¾—æ©Ÿèƒ½ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã€æ›¸å½±ï¼‰
        async function fetchAllBookInfo() {
            const url = inputs.bookUrl.value;
            if (!url || !isValidAmazonUrl(url)) {
                showFetchStatus('error', 'Amazon URLã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„', 'fetchAllStatus');
                return;
            }

            const fetchBtn = document.getElementById('fetchAllBtn');
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'ğŸš€ å–å¾—ä¸­...';
            showFetchStatus('loading', 'æ›¸ç±æƒ…å ±ã‚’å–å¾—ä¸­...', 'fetchAllStatus');

            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(url));
                
                if (!response.ok) {
                    throw new Error('ãƒšãƒ¼ã‚¸ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const html = await response.text();
                let successCount = 0;
                let results = [];
                
                // 1. ã‚¿ã‚¤ãƒˆãƒ«ã®æŠ½å‡º
                const titlePatterns = [
                    /<title[^>]*>([^<]+Amazon[^<]*|[^<]*ã‚¢ãƒã‚¾ãƒ³[^<]*)<\/title>/i,
                    /<span[^>]+id="[^"]*title[^"]*"[^>]*>([^<]+)<\/span>/i,
                    /<h1[^>]+class="[^"]*title[^"]*"[^>]*>([^<]+)<\/h1>/i,
                    /"title"\s*:\s*"([^"]+)"/,
                    /<meta[^>]+property="og:title"[^>]+content="([^"]+)"/i
                ];
                
                let title = null;
                for (const pattern of titlePatterns) {
                    const match = html.match(pattern);
                    if (match && match[1]) {
                        title = match[1]
                            .replace(/\s*[-|:]\s*Amazon.*$/i, '')
                            .replace(/\s*[-|:]\s*ã‚¢ãƒã‚¾ãƒ³.*$/i, '')
                            .replace(/\s*\|\s*.*$/, '')
                            .trim();
                        if (title.length > 5) {
                            break;
                        }
                    }
                }
                
                if (title && title.length <= 100) {
                    fetchedData.bookTitle = title;
                    results.push('ã‚¿ã‚¤ãƒˆãƒ«');
                    successCount++;
                }

                // 2. è‘—è€…åã®æŠ½å‡º - æ”¹è‰¯ç‰ˆã‚¨ãƒ³ã‚¸ãƒ³
                console.log('=== è‘—è€…åæŠ½å‡ºé–‹å§‹ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ ===');
                let author = await extractAuthorName(html, url);
                
                if (author && author.length <= 50) {
                    fetchedData.bookAuthor = author;
                    results.push('è‘—è€…å');
                    successCount++;
                } else if (!author) {
                    console.log('è‘—è€…åã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // 3. ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã®æŠ½å‡º
                const reviewPatterns = [
                    /(?:ãƒ¬ãƒ“ãƒ¥ãƒ¼|reviews?)\s*[ï¼š:]?\s*(\d+)\s*ä»¶/i,
                    /data-hook="total-review-count"[^>]*>([\d,]+)/i,
                    /"reviewCount"\s*:\s*(\d+)/i,
                    /(\d+)\s*(?:ä»¶ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼|reviews?)/i,
                    /(\d+)\s*å€‹ã®ã‚«ã‚¹ã‚¿ãƒãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼/i
                ];

                let reviewCount = null;
                for (const pattern of reviewPatterns) {
                    const match = html.match(pattern);
                    if (match) {
                        reviewCount = parseInt(match[1].replace(/,/g, ''));
                        if (!isNaN(reviewCount)) break;
                    }
                }

                if (reviewCount !== null && !isNaN(reviewCount)) {
                    fetchedData.currentReviews = reviewCount;
                    results.push('ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°');
                    successCount++;
                }

                // 4. æ›¸å½±ã®æŠ½å‡º
                const coverPatterns = [
                    /"hiRes":"([^"]+)"/,
                    /"large":"([^"]+)"/,
                    /<img[^>]+id="landingImage"[^>]+src="([^"]+)"/i,
                    /<img[^>]+class="[^"]*book[^"]*"[^>]+src="([^"]+)"/i,
                    /data-old-hires="([^"]+)"/,
                    /"imageUrl":"([^"]+)"/
                ];

                let coverUrl = null;
                for (const pattern of coverPatterns) {
                    const match = html.match(pattern);
                    if (match && match[1]) {
                        coverUrl = match[1].replace(/\\u002F/g, '/').replace(/\\/g, '');
                        if (coverUrl.startsWith('//')) {
                            coverUrl = 'https:' + coverUrl;
                        } else if (coverUrl.startsWith('/')) {
                            const urlObj = new URL(url);
                            coverUrl = urlObj.origin + coverUrl;
                        }
                        if (coverUrl.startsWith('http')) break;
                    }
                }

                if (coverUrl && coverUrl.startsWith('http')) {
                    fetchedData.bookCoverUrl = coverUrl;
                    results.push('æ›¸å½±');
                    successCount++;
                }

                if (successCount > 0) {
                    updatePreview();
                    showFetchStatus('success', `å–å¾—å®Œäº†: ${results.join('ã€')} (${successCount}/4é …ç›®)`, 'fetchAllStatus');
                } else {
                    showFetchStatus('error', 'æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'fetchAllStatus');
                }
            } catch (error) {
                console.error('æ›¸ç±æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showFetchStatus('error', 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'fetchAllStatus');
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'ğŸš€ è‡ªå‹•å–å¾—';
            }
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateForm() {
            let isValid = true;

            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.error').forEach(error => error.style.display = 'none');
            document.querySelectorAll('input').forEach(input => input.classList.remove('input-error'));

            // Amazon URLã®æ¤œè¨¼
            if (!inputs.bookUrl.value.trim()) {
                showError('bookUrl', 'bookUrlError');
                isValid = false;
            } else if (!isValidAmazonUrl(inputs.bookUrl.value)) {
                showError('bookUrl', 'bookUrlError');
                isValid = false;
            }

            // è‡ªå‹•å–å¾—ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
            if (!fetchedData.bookTitle.trim()) {
                alert('æ›¸ç±æƒ…å ±ã‚’è‡ªå‹•å–å¾—ã—ã¦ãã ã•ã„ã€‚');
                isValid = false;
            }

            // ç›®æ¨™ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã®æ¤œè¨¼
            const targetReviews = parseInt(inputs.targetReviews.value);
            if (isNaN(targetReviews) || targetReviews < 1) {
                showError('targetReviews', 'targetReviewsError');
                isValid = false;
            }

            // ã‚¹ãƒˆãƒ¬ãƒƒãƒç›®æ¨™ã®æ¤œè¨¼
            const stretchReviews = parseInt(inputs.stretchReviews.value);
            if (isNaN(stretchReviews) || stretchReviews <= targetReviews) {
                showError('stretchReviews', 'stretchReviewsError');
                isValid = false;
            }

            return isValid;
        }

        function showError(inputId, errorId) {
            inputs[inputId].classList.add('input-error');
            document.getElementById(errorId).style.display = 'block';
        }

        // å–å¾—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤º
        function showFetchStatus(type, message, statusId = 'fetchStatus') {
            const statusEl = document.getElementById(statusId);
            statusEl.className = `fetch-status ${type}`;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        Object.values(inputs).forEach(input => {
            input.addEventListener('input', updatePreview);
        });

        document.getElementById('fetchAllBtn').addEventListener('click', fetchAllBookInfo);
        document.getElementById('editAuthorBtn').addEventListener('click', editAuthorName);

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (validateForm()) {
                saveData();
                alert('è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼\n\nãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤ºãƒšãƒ¼ã‚¸ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // åˆæœŸåŒ–
        loadData();
        updatePreview();
    </script>

    <!-- Main application script -->
    <script type="module" src="main.js"></script>
</body>
</html>